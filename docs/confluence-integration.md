# Интеграция с Confluence
Confluence используется для формирования ответа на заданный пользователем вопрос и выдачи пользователю справочной информации.

## Требования к пространству на Confluence
Пространство на Confluence содержит страницы. Чат-бот повторяет древовидную структуру страниц, настроенную на Confluence. Эта структура предусматривает вложенность страниц (одна страница может содержать другие страницы в качестве вложенных), что используется для предоставления справки в чат-боте.

**ВАЖНО!**
 * В справочной навигации чат-бота отображаются **только страницы с тегом *"справка"***. 
 * Страницы, имеющие вложенные, считаются навигационными (в них нет полезной информации, есть только ссылки на вложенные страницы) и **не учитываются** при ответе на произвольные вопросы пользователя.
 * Вложенные файлы могут быть только в формате PDF и должны быть машиночитаемыми, т.е. текст из них легко копируется в другие приложения, а не представляет собой "кракозябры".

## Пример

![Рис. 1. Пример отображения структуры пространства в чат-боте](images/confluence_chatbot.png)
*Рис. 1.* Пример отображения структуры пространства в чат-боте

Рассмотрим пример (рис. 1) отображения структуры пространства в чат-боте VK (полностью аналогичен чат-боту в Telegram). При нажатии на кнопку "Справка" в чат-боте пользователю отправляются кнопки первого уровня дерева страниц на Confluence, при этом страница "Обучение" не предложена пользователю чат-бота, так как ей не присвоен тег ***"справка"***. 

При нажатии в чат-боте на одну из кнопок первого уровня (в примере это "Справки для студентов") пользователь получает кнопки второго уровня, вложенные в соответствующую страницу. При этом также могут быть страницы 3, 4 и последующих уровней. 

Если выбранная пользователем страница **не имеет вложенных страниц** (как, например, "Справка с оценками (академическая)"), чат-бот отправляет в диалог текст выбранной страницы. Также она учтётся при подборе документа, по которому искусственный интеллект должен дать ответ, если пользователь задаст чат-боту произвольный вопрос (например, "Сколько готовится справка с оценками?").

## Возможные задержки в синхронизации с Confleunce
Выгрузка справочной структуры в чат-бот осуществляется в режиме онлайн с использованием часового кеширования, т.е. структура дерева страниц и информация сохраняются во внутренней памяти чат-бота и не запрашиваются вновь из Confluence, если с момента прошлого запроса прошло менее часа.

Для ответов на произвольные вопросы пользователей документы подбираются не напрямую из Confluence, а из отдельной поисковой (векторной) базы данных, синхронизация с Confluence осуществляется 1 раз в сутки в 18:05.
